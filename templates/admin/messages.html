{% extends "base.html" %}
{% block title %}Murojaatlar - SmartBot.uz{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h2 class="text-white mb-1">
            <i class="fas fa-envelope me-2 text-warning"></i>
            Murojaatlar
          </h2>
          <p class="text-white-50 mb-0">Mijozlardan kelgan barcha xabarlar</p>
        </div>
        <div>
          <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-light">
            <i class="fas fa-arrow-left me-1"></i>Dashboard
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, msg in messages %}
        <div class="alert alert-{{ 'danger' if category=='error' else 'success' }} alert-dismissible fade show" role="alert">
          {{ msg }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- Search and Filter Controls -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="input-group">
        <span class="input-group-text bg-dark text-white border-secondary">
          <i class="fas fa-search"></i>
        </span>
        <input type="text" id="searchInput" class="form-control bg-dark text-white border-secondary" 
               placeholder="Ism, email yoki xabar bo'yicha qidiruv...">
      </div>
    </div>
    <div class="col-md-3">
      <select id="statusFilter" class="form-select bg-dark text-white border-secondary">
        <option value="">Barcha murojaatlar</option>
        <option value="yangi">Faqat yangilar</option>
        <option value="ko'rilgan">Ko'rilganlar</option>
      </select>
    </div>
    <div class="col-md-3">
      <a href="{{ url_for('export_messages_csv') }}" class="btn btn-success w-100">
        <i class="fas fa-download me-1"></i>CSV yuklash
      </a>
    </div>
  </div>

  <!-- Messages List -->
  <div class="row">
    <div class="col-12">
      {% if messages %}
        {% for message in messages %}
        <div class="card mb-3 message-card" data-status="{{ message.status }}" data-name="{{ message.name|lower }}" data-email="{{ message.email|lower }}" data-message="{{ message.message|lower }}" style="background-color: rgba(52, 58, 64, 0.9); border: 1px solid rgba(255,255,255,0.1);">
          <div class="card-header d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
              <h5 class="text-white mb-0">
                <i class="fas fa-user me-2 text-primary"></i>
                {{ message.name }}
              </h5>
              {% if message.status == 'yangi' %}
                <span class="badge bg-danger ms-2">Yangi</span>
              {% elif message.status == 'ko\'rilgan' %}
                <span class="badge bg-success ms-2">Ko'rilgan</span>
              {% endif %}
            </div>
            <small class="text-white-50">
              <i class="fas fa-clock me-1"></i>
              {{ message.date }}
            </small>
          </div>
          
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <p class="text-white-50 mb-1">
                  <i class="fas fa-envelope me-2 text-info"></i>
                  <strong>Email:</strong> {{ message.email }}
                </p>
                {% if message.phone %}
                <p class="text-white-50 mb-1">
                  <i class="fas fa-phone me-2 text-success"></i>
                  <strong>Telefon:</strong> {{ message.phone }}
                </p>
                {% endif %}
                {% if message.service %}
                <p class="text-white-50 mb-1">
                  <i class="fas fa-cog me-2 text-warning"></i>
                  <strong>Xizmat:</strong> {{ message.service }}
                </p>
                {% endif %}
                {% if message.budget %}
                <p class="text-white-50 mb-1">
                  <i class="fas fa-dollar-sign me-2 text-success"></i>
                  <strong>Byudjet:</strong> {{ message.budget }}
                </p>
                {% endif %}
              </div>
              
              <div class="col-md-6">
                <p class="text-white-50 mb-1">
                  <i class="fas fa-paper-plane me-2 {{ 'text-success' if message.telegram_sent else 'text-danger' }}"></i>
                  <strong>Telegram:</strong> 
                  {% if message.telegram_sent %}
                    <span class="text-success">Yuborildi</span>
                  {% else %}
                    <span class="text-danger">Yuborilmadi</span>
                  {% endif %}
                </p>
              </div>
            </div>
            
            <div class="mt-3">
              <h6 class="text-white">
                <i class="fas fa-comment me-2 text-primary"></i>
                Xabar:
              </h6>
              <div class="bg-dark p-3 rounded">
                <p class="text-white mb-0">{{ message.message }}</p>
              </div>
            </div>
            
            <div class="mt-3 d-flex gap-2">
              {% if message.status == 'yangi' %}
                <a href="{{ url_for('admin_message_mark_read', message_id=message.id) }}" 
                   class="btn btn-success btn-sm">
                  <i class="fas fa-check me-1"></i>Ko'rilgan deb belgilash
                </a>
              {% endif %}
              
              <a href="{{ url_for('admin_message_delete', message_id=message.id) }}" 
                 class="btn btn-danger btn-sm"
                 onclick="return confirm('Haqiqatan ham bu xabarni o\'chirmoqchimisiz?')">
                <i class="fas fa-trash me-1"></i>O'chirish
              </a>
            </div>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <div class="card text-center" style="background-color: rgba(52, 58, 64, 0.9); border: 1px solid rgba(255,255,255,0.1);">
          <div class="card-body py-5">
            <i class="fas fa-inbox fa-3x text-white-50 mb-3"></i>
            <h4 class="text-white">Hech qanday murojaat yo'q</h4>
            <p class="text-white-50">Mijozlardan murojaat kelganda bu yerda ko'rinadi</p>
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
// Qidiruv funksiyasi
document.getElementById('searchInput').addEventListener('keyup', function() {
  const filter = this.value.toLowerCase();
  filterMessages();
});

// Status filter funksiyasi
document.getElementById('statusFilter').addEventListener('change', function() {
  filterMessages();
});

function filterMessages() {
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  const statusFilter = document.getElementById('statusFilter').value;
  const messageCards = document.querySelectorAll('.message-card');
  
  messageCards.forEach(card => {
    const name = card.dataset.name;
    const email = card.dataset.email;
    const message = card.dataset.message;
    const status = card.dataset.status;
    
    const matchesSearch = searchTerm === '' || 
                         name.includes(searchTerm) || 
                         email.includes(searchTerm) || 
                         message.includes(searchTerm);
    
    const matchesStatus = statusFilter === '' || status === statusFilter;
    
    if (matchesSearch && matchesStatus) {
      card.style.display = '';
    } else {
      card.style.display = 'none';
    }
  });
}

// Real vaqtda yangilanish (har 30 soniyada)
function updateUnreadCount() {
  fetch('/api/unread-count')
    .then(response => response.json())
    .then(data => {
      // Dashboard'dagi badge ni yangilash
      const badge = document.querySelector('.badge.bg-danger');
      if (badge && data.count > 0) {
        badge.textContent = data.count;
        badge.style.display = 'inline';
      } else if (badge && data.count === 0) {
        badge.style.display = 'none';
      }
    })
    .catch(error => console.log('Yangilanish xatosi:', error));
}

// Har 30 soniyada yangilanish
setInterval(updateUnreadCount, 30000);

// Sahifa yuklanganda ham tekshirish
document.addEventListener('DOMContentLoaded', updateUnreadCount);

// Admin sahifada navbar yashirish uchun
document.body.classList.add('admin-page');
</script>
{% endblock %}